'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

(function (global, factory) {
  if (typeof define === 'function' && define.amd) {
    define(['exports', 'module', './util'], factory);
  } else if (typeof exports !== 'undefined' && typeof module !== 'undefined') {
    factory(exports, module, require('./util'));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, mod, global.Util);
    global.scrollspy = mod.exports;
  }
})(undefined, function (exports, module, _util) {
  'use strict';

  var _createClass = function () {
    function defineProperties(target, props) {
      for (var i = 0; i < props.length; i++) {
        var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ('value' in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
      }
    }return function (Constructor, protoProps, staticProps) {
      if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
  }();

  function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : { 'default': obj };
  }

  function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
      throw new TypeError('Cannot call a class as a function');
    }
  }

  var _Util = _interopRequireDefault(_util);

  /**
   * --------------------------------------------------------------------------
   * Bootstrap (v4.0.0-alpha.2): scrollspy.js
   * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
   * --------------------------------------------------------------------------
   */

  var ScrollSpy = function ($) {

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    var NAME = 'scrollspy';
    var VERSION = '4.0.0-alpha';
    var DATA_KEY = 'bs.scrollspy';
    var EVENT_KEY = '.' + DATA_KEY;
    var DATA_API_KEY = '.data-api';
    var JQUERY_NO_CONFLICT = $.fn[NAME];

    var Default = {
      offset: 10,
      method: 'auto',
      target: ''
    };

    var DefaultType = {
      offset: 'number',
      method: 'string',
      target: '(string|element)'
    };

    var Event = {
      ACTIVATE: 'activate' + EVENT_KEY,
      SCROLL: 'scroll' + EVENT_KEY,
      LOAD_DATA_API: 'load' + EVENT_KEY + DATA_API_KEY
    };

    var ClassName = {
      DROPDOWN_ITEM: 'dropdown-item',
      DROPDOWN_MENU: 'dropdown-menu',
      NAV_LINK: 'nav-link',
      NAV: 'nav',
      ACTIVE: 'active'
    };

    var Selector = {
      DATA_SPY: '[data-spy="scroll"]',
      ACTIVE: '.active',
      LIST_ITEM: '.list-item',
      LI: 'li',
      LI_DROPDOWN: 'li.dropdown',
      NAV_LINKS: '.nav-link',
      DROPDOWN: '.dropdown',
      DROPDOWN_ITEMS: '.dropdown-item',
      DROPDOWN_TOGGLE: '.dropdown-toggle'
    };

    var OffsetMethod = {
      OFFSET: 'offset',
      POSITION: 'position'
    };

    /**
     * ------------------------------------------------------------------------
     * Class Definition
     * ------------------------------------------------------------------------
     */

    var ScrollSpy = function () {
      function ScrollSpy(element, config) {
        _classCallCheck(this, ScrollSpy);

        this._element = element;
        this._scrollElement = element.tagName === 'BODY' ? window : element;
        this._config = this._getConfig(config);
        this._selector = this._config.target + ' ' + Selector.NAV_LINKS + ',' + (this._config.target + ' ' + Selector.DROPDOWN_ITEMS);
        this._offsets = [];
        this._targets = [];
        this._activeTarget = null;
        this._scrollHeight = 0;

        $(this._scrollElement).on(Event.SCROLL, $.proxy(this._process, this));

        this.refresh();
        this._process();
      }

      /**
       * ------------------------------------------------------------------------
       * Data Api implementation
       * ------------------------------------------------------------------------
       */

      // getters

      _createClass(ScrollSpy, [{
        key: 'refresh',

        // public

        value: function refresh() {
          var _this = this;

          var autoMethod = this._scrollElement !== this._scrollElement.window ? OffsetMethod.POSITION : OffsetMethod.OFFSET;

          var offsetMethod = this._config.method === 'auto' ? autoMethod : this._config.method;

          var offsetBase = offsetMethod === OffsetMethod.POSITION ? this._getScrollTop() : 0;

          this._offsets = [];
          this._targets = [];

          this._scrollHeight = this._getScrollHeight();

          var targets = $.makeArray($(this._selector));

          targets.map(function (element) {
            var target = undefined;
            var targetSelector = _Util['default'].getSelectorFromElement(element);

            if (targetSelector) {
              target = $(targetSelector)[0];
            }

            if (target && (target.offsetWidth || target.offsetHeight)) {
              // todo (fat): remove sketch reliance on jQuery position/offset
              return [$(target)[offsetMethod]().top + offsetBase, targetSelector];
            }
          }).filter(function (item) {
            return item;
          }).sort(function (a, b) {
            return a[0] - b[0];
          }).forEach(function (item) {
            _this._offsets.push(item[0]);
            _this._targets.push(item[1]);
          });
        }
      }, {
        key: 'dispose',
        value: function dispose() {
          $.removeData(this._element, DATA_KEY);
          $(this._scrollElement).off(EVENT_KEY);

          this._element = null;
          this._scrollElement = null;
          this._config = null;
          this._selector = null;
          this._offsets = null;
          this._targets = null;
          this._activeTarget = null;
          this._scrollHeight = null;
        }

        // private

      }, {
        key: '_getConfig',
        value: function _getConfig(config) {
          config = $.extend({}, Default, config);

          if (typeof config.target !== 'string') {
            var id = $(config.target).attr('id');
            if (!id) {
              id = _Util['default'].getUID(NAME);
              $(config.target).attr('id', id);
            }
            config.target = '#' + id;
          }

          _Util['default'].typeCheckConfig(NAME, config, DefaultType);

          return config;
        }
      }, {
        key: '_getScrollTop',
        value: function _getScrollTop() {
          return this._scrollElement === window ? this._scrollElement.scrollY : this._scrollElement.scrollTop;
        }
      }, {
        key: '_getScrollHeight',
        value: function _getScrollHeight() {
          return this._scrollElement.scrollHeight || Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        }
      }, {
        key: '_process',
        value: function _process() {
          var scrollTop = this._getScrollTop() + this._config.offset;
          var scrollHeight = this._getScrollHeight();
          var maxScroll = this._config.offset + scrollHeight - this._scrollElement.offsetHeight;

          if (this._scrollHeight !== scrollHeight) {
            this.refresh();
          }

          if (scrollTop >= maxScroll) {
            var target = this._targets[this._targets.length - 1];

            if (this._activeTarget !== target) {
              this._activate(target);
            }
          }

          if (this._activeTarget && scrollTop < this._offsets[0]) {
            this._activeTarget = null;
            this._clear();
            return;
          }

          for (var i = this._offsets.length; i--;) {
            var isActiveTarget = this._activeTarget !== this._targets[i] && scrollTop >= this._offsets[i] && (this._offsets[i + 1] === undefined || scrollTop < this._offsets[i + 1]);

            if (isActiveTarget) {
              this._activate(this._targets[i]);
            }
          }
        }
      }, {
        key: '_activate',
        value: function _activate(target) {
          this._activeTarget = target;

          this._clear();

          var queries = this._selector.split(',');
          queries = queries.map(function (selector) {
            return selector + '[data-target="' + target + '"],' + (selector + '[href="' + target + '"]');
          });

          var $link = $(queries.join(','));

          if ($link.hasClass(ClassName.DROPDOWN_ITEM)) {
            $link.closest(Selector.DROPDOWN).find(Selector.DROPDOWN_TOGGLE).addClass(ClassName.ACTIVE);
            $link.addClass(ClassName.ACTIVE);
          } else {
            // todo (fat) this is kinda susâ€¦
            // recursively add actives to tested nav-links
            $link.parents(Selector.LI).find(Selector.NAV_LINKS).addClass(ClassName.ACTIVE);
          }

          $(this._scrollElement).trigger(Event.ACTIVATE, {
            relatedTarget: target
          });
        }
      }, {
        key: '_clear',
        value: function _clear() {
          $(this._selector).filter(Selector.ACTIVE).removeClass(ClassName.ACTIVE);
        }

        // static

      }], [{
        key: '_jQueryInterface',
        value: function _jQueryInterface(config) {
          return this.each(function () {
            var data = $(this).data(DATA_KEY);
            var _config = (typeof config === 'undefined' ? 'undefined' : _typeof(config)) === 'object' && config || null;

            if (!data) {
              data = new ScrollSpy(this, _config);
              $(this).data(DATA_KEY, data);
            }

            if (typeof config === 'string') {
              if (data[config] === undefined) {
                throw new Error('No method named "' + config + '"');
              }
              data[config]();
            }
          });
        }
      }, {
        key: 'VERSION',
        get: function get() {
          return VERSION;
        }
      }, {
        key: 'Default',
        get: function get() {
          return Default;
        }
      }]);

      return ScrollSpy;
    }();

    $(window).on(Event.LOAD_DATA_API, function () {
      var scrollSpys = $.makeArray($(Selector.DATA_SPY));

      for (var i = scrollSpys.length; i--;) {
        var $spy = $(scrollSpys[i]);
        ScrollSpy._jQueryInterface.call($spy, $spy.data());
      }
    });

    /**
     * ------------------------------------------------------------------------
     * jQuery
     * ------------------------------------------------------------------------
     */

    $.fn[NAME] = ScrollSpy._jQueryInterface;
    $.fn[NAME].Constructor = ScrollSpy;
    $.fn[NAME].noConflict = function () {
      $.fn[NAME] = JQUERY_NO_CONFLICT;
      return ScrollSpy._jQueryInterface;
    };

    return ScrollSpy;
  }(jQuery);

  module.exports = ScrollSpy;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2NsaWVudC9saWIvYm9vdHN0cmFwL2Rpc3QvanMvdW1kL3Njcm9sbHNweS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsQ0FBQyxVQUFVLE1BQVYsRUFBa0IsT0FBbEIsRUFBMkI7QUFDMUIsTUFBSSxPQUFPLE1BQVAsS0FBa0IsVUFBbEIsSUFBZ0MsT0FBTyxHQUEzQyxFQUFnRDtBQUM5QyxXQUFPLENBQUMsU0FBRCxFQUFZLFFBQVosRUFBc0IsUUFBdEIsQ0FBUCxFQUF3QyxPQUF4QztBQUNELEdBRkQsTUFFTyxJQUFJLE9BQU8sT0FBUCxLQUFtQixXQUFuQixJQUFrQyxPQUFPLE1BQVAsS0FBa0IsV0FBeEQsRUFBcUU7QUFDMUUsWUFBUSxPQUFSLEVBQWlCLE1BQWpCLEVBQXlCLFFBQVEsUUFBUixDQUF6QjtBQUNELEdBRk0sTUFFQTtBQUNMLFFBQUksTUFBTTtBQUNSLGVBQVM7QUFERCxLQUFWO0FBR0EsWUFBUSxJQUFJLE9BQVosRUFBcUIsR0FBckIsRUFBMEIsT0FBTyxJQUFqQztBQUNBLFdBQU8sU0FBUCxHQUFtQixJQUFJLE9BQXZCO0FBQ0Q7QUFDRixDQVpELGFBWVMsVUFBVSxPQUFWLEVBQW1CLE1BQW5CLEVBQTJCLEtBQTNCLEVBQWtDO0FBQ3pDOztBQUVBLE1BQUksZUFBZ0IsWUFBWTtBQUFFLGFBQVMsZ0JBQVQsQ0FBMEIsTUFBMUIsRUFBa0MsS0FBbEMsRUFBeUM7QUFBRSxXQUFLLElBQUksSUFBSSxDQUFiLEVBQWdCLElBQUksTUFBTSxNQUExQixFQUFrQyxHQUFsQyxFQUF1QztBQUFFLFlBQUksYUFBYSxNQUFNLENBQU4sQ0FBakIsQ0FBMkIsV0FBVyxVQUFYLEdBQXdCLFdBQVcsVUFBWCxJQUF5QixLQUFqRCxDQUF3RCxXQUFXLFlBQVgsR0FBMEIsSUFBMUIsQ0FBZ0MsSUFBSSxXQUFXLFVBQWYsRUFBMkIsV0FBVyxRQUFYLEdBQXNCLElBQXRCLENBQTRCLE9BQU8sY0FBUCxDQUFzQixNQUF0QixFQUE4QixXQUFXLEdBQXpDLEVBQThDLFVBQTlDO0FBQTREO0FBQUUsS0FBQyxPQUFPLFVBQVUsV0FBVixFQUF1QixVQUF2QixFQUFtQyxXQUFuQyxFQUFnRDtBQUFFLFVBQUksVUFBSixFQUFnQixpQkFBaUIsWUFBWSxTQUE3QixFQUF3QyxVQUF4QyxFQUFxRCxJQUFJLFdBQUosRUFBaUIsaUJBQWlCLFdBQWpCLEVBQThCLFdBQTlCLEVBQTRDLE9BQU8sV0FBUDtBQUFxQixLQUFoTjtBQUFtTixHQUEvaEIsRUFBbkI7O0FBRUEsV0FBUyxzQkFBVCxDQUFnQyxHQUFoQyxFQUFxQztBQUFFLFdBQU8sT0FBTyxJQUFJLFVBQVgsR0FBd0IsR0FBeEIsR0FBOEIsRUFBRSxXQUFXLEdBQWIsRUFBckM7QUFBMEQ7O0FBRWpHLFdBQVMsZUFBVCxDQUF5QixRQUF6QixFQUFtQyxXQUFuQyxFQUFnRDtBQUFFLFFBQUksRUFBRSxvQkFBb0IsV0FBdEIsQ0FBSixFQUF3QztBQUFFLFlBQU0sSUFBSSxTQUFKLENBQWMsbUNBQWQsQ0FBTjtBQUEyRDtBQUFFOztBQUV6SixNQUFJLFFBQVEsdUJBQXVCLEtBQXZCLENBQVo7Ozs7Ozs7OztBQVNBLE1BQUksWUFBYSxVQUFVLENBQVYsRUFBYTs7Ozs7Ozs7QUFRNUIsUUFBSSxPQUFPLFdBQVg7QUFDQSxRQUFJLFVBQVUsYUFBZDtBQUNBLFFBQUksV0FBVyxjQUFmO0FBQ0EsUUFBSSxZQUFZLE1BQU0sUUFBdEI7QUFDQSxRQUFJLGVBQWUsV0FBbkI7QUFDQSxRQUFJLHFCQUFxQixFQUFFLEVBQUYsQ0FBSyxJQUFMLENBQXpCOztBQUVBLFFBQUksVUFBVTtBQUNaLGNBQVEsRUFESTtBQUVaLGNBQVEsTUFGSTtBQUdaLGNBQVE7QUFISSxLQUFkOztBQU1BLFFBQUksY0FBYztBQUNoQixjQUFRLFFBRFE7QUFFaEIsY0FBUSxRQUZRO0FBR2hCLGNBQVE7QUFIUSxLQUFsQjs7QUFNQSxRQUFJLFFBQVE7QUFDVixnQkFBVSxhQUFhLFNBRGI7QUFFVixjQUFRLFdBQVcsU0FGVDtBQUdWLHFCQUFlLFNBQVMsU0FBVCxHQUFxQjtBQUgxQixLQUFaOztBQU1BLFFBQUksWUFBWTtBQUNkLHFCQUFlLGVBREQ7QUFFZCxxQkFBZSxlQUZEO0FBR2QsZ0JBQVUsVUFISTtBQUlkLFdBQUssS0FKUztBQUtkLGNBQVE7QUFMTSxLQUFoQjs7QUFRQSxRQUFJLFdBQVc7QUFDYixnQkFBVSxxQkFERztBQUViLGNBQVEsU0FGSztBQUdiLGlCQUFXLFlBSEU7QUFJYixVQUFJLElBSlM7QUFLYixtQkFBYSxhQUxBO0FBTWIsaUJBQVcsV0FORTtBQU9iLGdCQUFVLFdBUEc7QUFRYixzQkFBZ0IsZ0JBUkg7QUFTYix1QkFBaUI7QUFUSixLQUFmOztBQVlBLFFBQUksZUFBZTtBQUNqQixjQUFRLFFBRFM7QUFFakIsZ0JBQVU7QUFGTyxLQUFuQjs7Ozs7Ozs7QUFXQSxRQUFJLFlBQWEsWUFBWTtBQUMzQixlQUFTLFNBQVQsQ0FBbUIsT0FBbkIsRUFBNEIsTUFBNUIsRUFBb0M7QUFDbEMsd0JBQWdCLElBQWhCLEVBQXNCLFNBQXRCOztBQUVBLGFBQUssUUFBTCxHQUFnQixPQUFoQjtBQUNBLGFBQUssY0FBTCxHQUFzQixRQUFRLE9BQVIsS0FBb0IsTUFBcEIsR0FBNkIsTUFBN0IsR0FBc0MsT0FBNUQ7QUFDQSxhQUFLLE9BQUwsR0FBZSxLQUFLLFVBQUwsQ0FBZ0IsTUFBaEIsQ0FBZjtBQUNBLGFBQUssU0FBTCxHQUFpQixLQUFLLE9BQUwsQ0FBYSxNQUFiLEdBQXNCLEdBQXRCLEdBQTRCLFNBQVMsU0FBckMsR0FBaUQsR0FBakQsSUFBd0QsS0FBSyxPQUFMLENBQWEsTUFBYixHQUFzQixHQUF0QixHQUE0QixTQUFTLGNBQTdGLENBQWpCO0FBQ0EsYUFBSyxRQUFMLEdBQWdCLEVBQWhCO0FBQ0EsYUFBSyxRQUFMLEdBQWdCLEVBQWhCO0FBQ0EsYUFBSyxhQUFMLEdBQXFCLElBQXJCO0FBQ0EsYUFBSyxhQUFMLEdBQXFCLENBQXJCOztBQUVBLFVBQUUsS0FBSyxjQUFQLEVBQXVCLEVBQXZCLENBQTBCLE1BQU0sTUFBaEMsRUFBd0MsRUFBRSxLQUFGLENBQVEsS0FBSyxRQUFiLEVBQXVCLElBQXZCLENBQXhDOztBQUVBLGFBQUssT0FBTDtBQUNBLGFBQUssUUFBTDtBQUNEOzs7Ozs7Ozs7O0FBVUQsbUJBQWEsU0FBYixFQUF3QixDQUFDO0FBQ3ZCLGFBQUssU0FEa0I7Ozs7QUFLdkIsZUFBTyxTQUFTLE9BQVQsR0FBbUI7QUFDeEIsY0FBSSxRQUFRLElBQVo7O0FBRUEsY0FBSSxhQUFhLEtBQUssY0FBTCxLQUF3QixLQUFLLGNBQUwsQ0FBb0IsTUFBNUMsR0FBcUQsYUFBYSxRQUFsRSxHQUE2RSxhQUFhLE1BQTNHOztBQUVBLGNBQUksZUFBZSxLQUFLLE9BQUwsQ0FBYSxNQUFiLEtBQXdCLE1BQXhCLEdBQWlDLFVBQWpDLEdBQThDLEtBQUssT0FBTCxDQUFhLE1BQTlFOztBQUVBLGNBQUksYUFBYSxpQkFBaUIsYUFBYSxRQUE5QixHQUF5QyxLQUFLLGFBQUwsRUFBekMsR0FBZ0UsQ0FBakY7O0FBRUEsZUFBSyxRQUFMLEdBQWdCLEVBQWhCO0FBQ0EsZUFBSyxRQUFMLEdBQWdCLEVBQWhCOztBQUVBLGVBQUssYUFBTCxHQUFxQixLQUFLLGdCQUFMLEVBQXJCOztBQUVBLGNBQUksVUFBVSxFQUFFLFNBQUYsQ0FBWSxFQUFFLEtBQUssU0FBUCxDQUFaLENBQWQ7O0FBRUEsa0JBQVEsR0FBUixDQUFZLFVBQVUsT0FBVixFQUFtQjtBQUM3QixnQkFBSSxTQUFTLFNBQWI7QUFDQSxnQkFBSSxpQkFBaUIsTUFBTSxTQUFOLEVBQWlCLHNCQUFqQixDQUF3QyxPQUF4QyxDQUFyQjs7QUFFQSxnQkFBSSxjQUFKLEVBQW9CO0FBQ2xCLHVCQUFTLEVBQUUsY0FBRixFQUFrQixDQUFsQixDQUFUO0FBQ0Q7O0FBRUQsZ0JBQUksV0FBVyxPQUFPLFdBQVAsSUFBc0IsT0FBTyxZQUF4QyxDQUFKLEVBQTJEOztBQUV6RCxxQkFBTyxDQUFDLEVBQUUsTUFBRixFQUFVLFlBQVYsSUFBMEIsR0FBMUIsR0FBZ0MsVUFBakMsRUFBNkMsY0FBN0MsQ0FBUDtBQUNEO0FBQ0YsV0FaRCxFQVlHLE1BWkgsQ0FZVSxVQUFVLElBQVYsRUFBZ0I7QUFDeEIsbUJBQU8sSUFBUDtBQUNELFdBZEQsRUFjRyxJQWRILENBY1EsVUFBVSxDQUFWLEVBQWEsQ0FBYixFQUFnQjtBQUN0QixtQkFBTyxFQUFFLENBQUYsSUFBTyxFQUFFLENBQUYsQ0FBZDtBQUNELFdBaEJELEVBZ0JHLE9BaEJILENBZ0JXLFVBQVUsSUFBVixFQUFnQjtBQUN6QixrQkFBTSxRQUFOLENBQWUsSUFBZixDQUFvQixLQUFLLENBQUwsQ0FBcEI7QUFDQSxrQkFBTSxRQUFOLENBQWUsSUFBZixDQUFvQixLQUFLLENBQUwsQ0FBcEI7QUFDRCxXQW5CRDtBQW9CRDtBQXpDc0IsT0FBRCxFQTBDckI7QUFDRCxhQUFLLFNBREo7QUFFRCxlQUFPLFNBQVMsT0FBVCxHQUFtQjtBQUN4QixZQUFFLFVBQUYsQ0FBYSxLQUFLLFFBQWxCLEVBQTRCLFFBQTVCO0FBQ0EsWUFBRSxLQUFLLGNBQVAsRUFBdUIsR0FBdkIsQ0FBMkIsU0FBM0I7O0FBRUEsZUFBSyxRQUFMLEdBQWdCLElBQWhCO0FBQ0EsZUFBSyxjQUFMLEdBQXNCLElBQXRCO0FBQ0EsZUFBSyxPQUFMLEdBQWUsSUFBZjtBQUNBLGVBQUssU0FBTCxHQUFpQixJQUFqQjtBQUNBLGVBQUssUUFBTCxHQUFnQixJQUFoQjtBQUNBLGVBQUssUUFBTCxHQUFnQixJQUFoQjtBQUNBLGVBQUssYUFBTCxHQUFxQixJQUFyQjtBQUNBLGVBQUssYUFBTCxHQUFxQixJQUFyQjtBQUNEOzs7O0FBZEEsT0ExQ3FCLEVBNERyQjtBQUNELGFBQUssWUFESjtBQUVELGVBQU8sU0FBUyxVQUFULENBQW9CLE1BQXBCLEVBQTRCO0FBQ2pDLG1CQUFTLEVBQUUsTUFBRixDQUFTLEVBQVQsRUFBYSxPQUFiLEVBQXNCLE1BQXRCLENBQVQ7O0FBRUEsY0FBSSxPQUFPLE9BQU8sTUFBZCxLQUF5QixRQUE3QixFQUF1QztBQUNyQyxnQkFBSSxLQUFLLEVBQUUsT0FBTyxNQUFULEVBQWlCLElBQWpCLENBQXNCLElBQXRCLENBQVQ7QUFDQSxnQkFBSSxDQUFDLEVBQUwsRUFBUztBQUNQLG1CQUFLLE1BQU0sU0FBTixFQUFpQixNQUFqQixDQUF3QixJQUF4QixDQUFMO0FBQ0EsZ0JBQUUsT0FBTyxNQUFULEVBQWlCLElBQWpCLENBQXNCLElBQXRCLEVBQTRCLEVBQTVCO0FBQ0Q7QUFDRCxtQkFBTyxNQUFQLEdBQWdCLE1BQU0sRUFBdEI7QUFDRDs7QUFFRCxnQkFBTSxTQUFOLEVBQWlCLGVBQWpCLENBQWlDLElBQWpDLEVBQXVDLE1BQXZDLEVBQStDLFdBQS9DOztBQUVBLGlCQUFPLE1BQVA7QUFDRDtBQWpCQSxPQTVEcUIsRUE4RXJCO0FBQ0QsYUFBSyxlQURKO0FBRUQsZUFBTyxTQUFTLGFBQVQsR0FBeUI7QUFDOUIsaUJBQU8sS0FBSyxjQUFMLEtBQXdCLE1BQXhCLEdBQWlDLEtBQUssY0FBTCxDQUFvQixPQUFyRCxHQUErRCxLQUFLLGNBQUwsQ0FBb0IsU0FBMUY7QUFDRDtBQUpBLE9BOUVxQixFQW1GckI7QUFDRCxhQUFLLGtCQURKO0FBRUQsZUFBTyxTQUFTLGdCQUFULEdBQTRCO0FBQ2pDLGlCQUFPLEtBQUssY0FBTCxDQUFvQixZQUFwQixJQUFvQyxLQUFLLEdBQUwsQ0FBUyxTQUFTLElBQVQsQ0FBYyxZQUF2QixFQUFxQyxTQUFTLGVBQVQsQ0FBeUIsWUFBOUQsQ0FBM0M7QUFDRDtBQUpBLE9BbkZxQixFQXdGckI7QUFDRCxhQUFLLFVBREo7QUFFRCxlQUFPLFNBQVMsUUFBVCxHQUFvQjtBQUN6QixjQUFJLFlBQVksS0FBSyxhQUFMLEtBQXVCLEtBQUssT0FBTCxDQUFhLE1BQXBEO0FBQ0EsY0FBSSxlQUFlLEtBQUssZ0JBQUwsRUFBbkI7QUFDQSxjQUFJLFlBQVksS0FBSyxPQUFMLENBQWEsTUFBYixHQUFzQixZQUF0QixHQUFxQyxLQUFLLGNBQUwsQ0FBb0IsWUFBekU7O0FBRUEsY0FBSSxLQUFLLGFBQUwsS0FBdUIsWUFBM0IsRUFBeUM7QUFDdkMsaUJBQUssT0FBTDtBQUNEOztBQUVELGNBQUksYUFBYSxTQUFqQixFQUE0QjtBQUMxQixnQkFBSSxTQUFTLEtBQUssUUFBTCxDQUFjLEtBQUssUUFBTCxDQUFjLE1BQWQsR0FBdUIsQ0FBckMsQ0FBYjs7QUFFQSxnQkFBSSxLQUFLLGFBQUwsS0FBdUIsTUFBM0IsRUFBbUM7QUFDakMsbUJBQUssU0FBTCxDQUFlLE1BQWY7QUFDRDtBQUNGOztBQUVELGNBQUksS0FBSyxhQUFMLElBQXNCLFlBQVksS0FBSyxRQUFMLENBQWMsQ0FBZCxDQUF0QyxFQUF3RDtBQUN0RCxpQkFBSyxhQUFMLEdBQXFCLElBQXJCO0FBQ0EsaUJBQUssTUFBTDtBQUNBO0FBQ0Q7O0FBRUQsZUFBSyxJQUFJLElBQUksS0FBSyxRQUFMLENBQWMsTUFBM0IsRUFBbUMsR0FBbkMsR0FBeUM7QUFDdkMsZ0JBQUksaUJBQWlCLEtBQUssYUFBTCxLQUF1QixLQUFLLFFBQUwsQ0FBYyxDQUFkLENBQXZCLElBQTJDLGFBQWEsS0FBSyxRQUFMLENBQWMsQ0FBZCxDQUF4RCxLQUE2RSxLQUFLLFFBQUwsQ0FBYyxJQUFJLENBQWxCLE1BQXlCLFNBQXpCLElBQXNDLFlBQVksS0FBSyxRQUFMLENBQWMsSUFBSSxDQUFsQixDQUEvSCxDQUFyQjs7QUFFQSxnQkFBSSxjQUFKLEVBQW9CO0FBQ2xCLG1CQUFLLFNBQUwsQ0FBZSxLQUFLLFFBQUwsQ0FBYyxDQUFkLENBQWY7QUFDRDtBQUNGO0FBQ0Y7QUFoQ0EsT0F4RnFCLEVBeUhyQjtBQUNELGFBQUssV0FESjtBQUVELGVBQU8sU0FBUyxTQUFULENBQW1CLE1BQW5CLEVBQTJCO0FBQ2hDLGVBQUssYUFBTCxHQUFxQixNQUFyQjs7QUFFQSxlQUFLLE1BQUw7O0FBRUEsY0FBSSxVQUFVLEtBQUssU0FBTCxDQUFlLEtBQWYsQ0FBcUIsR0FBckIsQ0FBZDtBQUNBLG9CQUFVLFFBQVEsR0FBUixDQUFZLFVBQVUsUUFBVixFQUFvQjtBQUN4QyxtQkFBTyxXQUFXLGdCQUFYLEdBQThCLE1BQTlCLEdBQXVDLEtBQXZDLElBQWdELFdBQVcsU0FBWCxHQUF1QixNQUF2QixHQUFnQyxJQUFoRixDQUFQO0FBQ0QsV0FGUyxDQUFWOztBQUlBLGNBQUksUUFBUSxFQUFFLFFBQVEsSUFBUixDQUFhLEdBQWIsQ0FBRixDQUFaOztBQUVBLGNBQUksTUFBTSxRQUFOLENBQWUsVUFBVSxhQUF6QixDQUFKLEVBQTZDO0FBQzNDLGtCQUFNLE9BQU4sQ0FBYyxTQUFTLFFBQXZCLEVBQWlDLElBQWpDLENBQXNDLFNBQVMsZUFBL0MsRUFBZ0UsUUFBaEUsQ0FBeUUsVUFBVSxNQUFuRjtBQUNBLGtCQUFNLFFBQU4sQ0FBZSxVQUFVLE1BQXpCO0FBQ0QsV0FIRCxNQUdPOzs7QUFHTCxrQkFBTSxPQUFOLENBQWMsU0FBUyxFQUF2QixFQUEyQixJQUEzQixDQUFnQyxTQUFTLFNBQXpDLEVBQW9ELFFBQXBELENBQTZELFVBQVUsTUFBdkU7QUFDRDs7QUFFRCxZQUFFLEtBQUssY0FBUCxFQUF1QixPQUF2QixDQUErQixNQUFNLFFBQXJDLEVBQStDO0FBQzdDLDJCQUFlO0FBRDhCLFdBQS9DO0FBR0Q7QUExQkEsT0F6SHFCLEVBb0pyQjtBQUNELGFBQUssUUFESjtBQUVELGVBQU8sU0FBUyxNQUFULEdBQWtCO0FBQ3ZCLFlBQUUsS0FBSyxTQUFQLEVBQWtCLE1BQWxCLENBQXlCLFNBQVMsTUFBbEMsRUFBMEMsV0FBMUMsQ0FBc0QsVUFBVSxNQUFoRTtBQUNEOzs7O0FBSkEsT0FwSnFCLENBQXhCLEVBNEpJLENBQUM7QUFDSCxhQUFLLGtCQURGO0FBRUgsZUFBTyxTQUFTLGdCQUFULENBQTBCLE1BQTFCLEVBQWtDO0FBQ3ZDLGlCQUFPLEtBQUssSUFBTCxDQUFVLFlBQVk7QUFDM0IsZ0JBQUksT0FBTyxFQUFFLElBQUYsRUFBUSxJQUFSLENBQWEsUUFBYixDQUFYO0FBQ0EsZ0JBQUksVUFBVSxRQUFPLE1BQVAseUNBQU8sTUFBUCxPQUFrQixRQUFsQixJQUE4QixNQUE5QixJQUF3QyxJQUF0RDs7QUFFQSxnQkFBSSxDQUFDLElBQUwsRUFBVztBQUNULHFCQUFPLElBQUksU0FBSixDQUFjLElBQWQsRUFBb0IsT0FBcEIsQ0FBUDtBQUNBLGdCQUFFLElBQUYsRUFBUSxJQUFSLENBQWEsUUFBYixFQUF1QixJQUF2QjtBQUNEOztBQUVELGdCQUFJLE9BQU8sTUFBUCxLQUFrQixRQUF0QixFQUFnQztBQUM5QixrQkFBSSxLQUFLLE1BQUwsTUFBaUIsU0FBckIsRUFBZ0M7QUFDOUIsc0JBQU0sSUFBSSxLQUFKLENBQVUsc0JBQXNCLE1BQXRCLEdBQStCLEdBQXpDLENBQU47QUFDRDtBQUNELG1CQUFLLE1BQUw7QUFDRDtBQUNGLFdBZk0sQ0FBUDtBQWdCRDtBQW5CRSxPQUFELEVBb0JEO0FBQ0QsYUFBSyxTQURKO0FBRUQsYUFBSyxTQUFTLEdBQVQsR0FBZTtBQUNsQixpQkFBTyxPQUFQO0FBQ0Q7QUFKQSxPQXBCQyxFQXlCRDtBQUNELGFBQUssU0FESjtBQUVELGFBQUssU0FBUyxHQUFULEdBQWU7QUFDbEIsaUJBQU8sT0FBUDtBQUNEO0FBSkEsT0F6QkMsQ0E1Sko7O0FBNExBLGFBQU8sU0FBUDtBQUNELEtBeE5lLEVBQWhCOztBQTBOQSxNQUFFLE1BQUYsRUFBVSxFQUFWLENBQWEsTUFBTSxhQUFuQixFQUFrQyxZQUFZO0FBQzVDLFVBQUksYUFBYSxFQUFFLFNBQUYsQ0FBWSxFQUFFLFNBQVMsUUFBWCxDQUFaLENBQWpCOztBQUVBLFdBQUssSUFBSSxJQUFJLFdBQVcsTUFBeEIsRUFBZ0MsR0FBaEMsR0FBc0M7QUFDcEMsWUFBSSxPQUFPLEVBQUUsV0FBVyxDQUFYLENBQUYsQ0FBWDtBQUNBLGtCQUFVLGdCQUFWLENBQTJCLElBQTNCLENBQWdDLElBQWhDLEVBQXNDLEtBQUssSUFBTCxFQUF0QztBQUNEO0FBQ0YsS0FQRDs7Ozs7Ozs7QUFlQSxNQUFFLEVBQUYsQ0FBSyxJQUFMLElBQWEsVUFBVSxnQkFBdkI7QUFDQSxNQUFFLEVBQUYsQ0FBSyxJQUFMLEVBQVcsV0FBWCxHQUF5QixTQUF6QjtBQUNBLE1BQUUsRUFBRixDQUFLLElBQUwsRUFBVyxVQUFYLEdBQXdCLFlBQVk7QUFDbEMsUUFBRSxFQUFGLENBQUssSUFBTCxJQUFhLGtCQUFiO0FBQ0EsYUFBTyxVQUFVLGdCQUFqQjtBQUNELEtBSEQ7O0FBS0EsV0FBTyxTQUFQO0FBQ0QsR0FqVGUsQ0FpVGIsTUFqVGEsQ0FBaEI7O0FBbVRBLFNBQU8sT0FBUCxHQUFpQixTQUFqQjtBQUNELENBbFZEIiwiZmlsZSI6InNjcm9sbHNweS5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7XG4gIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHtcbiAgICBkZWZpbmUoWydleHBvcnRzJywgJ21vZHVsZScsICcuL3V0aWwnXSwgZmFjdG9yeSk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgZmFjdG9yeShleHBvcnRzLCBtb2R1bGUsIHJlcXVpcmUoJy4vdXRpbCcpKTtcbiAgfSBlbHNlIHtcbiAgICB2YXIgbW9kID0ge1xuICAgICAgZXhwb3J0czoge31cbiAgICB9O1xuICAgIGZhY3RvcnkobW9kLmV4cG9ydHMsIG1vZCwgZ2xvYmFsLlV0aWwpO1xuICAgIGdsb2JhbC5zY3JvbGxzcHkgPSBtb2QuZXhwb3J0cztcbiAgfVxufSkodGhpcywgZnVuY3Rpb24gKGV4cG9ydHMsIG1vZHVsZSwgX3V0aWwpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7XG5cbiAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfVxuXG4gIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfVxuXG4gIHZhciBfVXRpbCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3V0aWwpO1xuXG4gIC8qKlxuICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgKiBCb290c3RyYXAgKHY0LjAuMC1hbHBoYS4yKTogc2Nyb2xsc3B5LmpzXG4gICAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpXG4gICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAqL1xuXG4gIHZhciBTY3JvbGxTcHkgPSAoZnVuY3Rpb24gKCQpIHtcblxuICAgIC8qKlxuICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAqIENvbnN0YW50c1xuICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAqL1xuXG4gICAgdmFyIE5BTUUgPSAnc2Nyb2xsc3B5JztcbiAgICB2YXIgVkVSU0lPTiA9ICc0LjAuMC1hbHBoYSc7XG4gICAgdmFyIERBVEFfS0VZID0gJ2JzLnNjcm9sbHNweSc7XG4gICAgdmFyIEVWRU5UX0tFWSA9ICcuJyArIERBVEFfS0VZO1xuICAgIHZhciBEQVRBX0FQSV9LRVkgPSAnLmRhdGEtYXBpJztcbiAgICB2YXIgSlFVRVJZX05PX0NPTkZMSUNUID0gJC5mbltOQU1FXTtcblxuICAgIHZhciBEZWZhdWx0ID0ge1xuICAgICAgb2Zmc2V0OiAxMCxcbiAgICAgIG1ldGhvZDogJ2F1dG8nLFxuICAgICAgdGFyZ2V0OiAnJ1xuICAgIH07XG5cbiAgICB2YXIgRGVmYXVsdFR5cGUgPSB7XG4gICAgICBvZmZzZXQ6ICdudW1iZXInLFxuICAgICAgbWV0aG9kOiAnc3RyaW5nJyxcbiAgICAgIHRhcmdldDogJyhzdHJpbmd8ZWxlbWVudCknXG4gICAgfTtcblxuICAgIHZhciBFdmVudCA9IHtcbiAgICAgIEFDVElWQVRFOiAnYWN0aXZhdGUnICsgRVZFTlRfS0VZLFxuICAgICAgU0NST0xMOiAnc2Nyb2xsJyArIEVWRU5UX0tFWSxcbiAgICAgIExPQURfREFUQV9BUEk6ICdsb2FkJyArIEVWRU5UX0tFWSArIERBVEFfQVBJX0tFWVxuICAgIH07XG5cbiAgICB2YXIgQ2xhc3NOYW1lID0ge1xuICAgICAgRFJPUERPV05fSVRFTTogJ2Ryb3Bkb3duLWl0ZW0nLFxuICAgICAgRFJPUERPV05fTUVOVTogJ2Ryb3Bkb3duLW1lbnUnLFxuICAgICAgTkFWX0xJTks6ICduYXYtbGluaycsXG4gICAgICBOQVY6ICduYXYnLFxuICAgICAgQUNUSVZFOiAnYWN0aXZlJ1xuICAgIH07XG5cbiAgICB2YXIgU2VsZWN0b3IgPSB7XG4gICAgICBEQVRBX1NQWTogJ1tkYXRhLXNweT1cInNjcm9sbFwiXScsXG4gICAgICBBQ1RJVkU6ICcuYWN0aXZlJyxcbiAgICAgIExJU1RfSVRFTTogJy5saXN0LWl0ZW0nLFxuICAgICAgTEk6ICdsaScsXG4gICAgICBMSV9EUk9QRE9XTjogJ2xpLmRyb3Bkb3duJyxcbiAgICAgIE5BVl9MSU5LUzogJy5uYXYtbGluaycsXG4gICAgICBEUk9QRE9XTjogJy5kcm9wZG93bicsXG4gICAgICBEUk9QRE9XTl9JVEVNUzogJy5kcm9wZG93bi1pdGVtJyxcbiAgICAgIERST1BET1dOX1RPR0dMRTogJy5kcm9wZG93bi10b2dnbGUnXG4gICAgfTtcblxuICAgIHZhciBPZmZzZXRNZXRob2QgPSB7XG4gICAgICBPRkZTRVQ6ICdvZmZzZXQnLFxuICAgICAgUE9TSVRJT046ICdwb3NpdGlvbidcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICogQ2xhc3MgRGVmaW5pdGlvblxuICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAqL1xuXG4gICAgdmFyIFNjcm9sbFNweSA9IChmdW5jdGlvbiAoKSB7XG4gICAgICBmdW5jdGlvbiBTY3JvbGxTcHkoZWxlbWVudCwgY29uZmlnKSB7XG4gICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTY3JvbGxTcHkpO1xuXG4gICAgICAgIHRoaXMuX2VsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICB0aGlzLl9zY3JvbGxFbGVtZW50ID0gZWxlbWVudC50YWdOYW1lID09PSAnQk9EWScgPyB3aW5kb3cgOiBlbGVtZW50O1xuICAgICAgICB0aGlzLl9jb25maWcgPSB0aGlzLl9nZXRDb25maWcoY29uZmlnKTtcbiAgICAgICAgdGhpcy5fc2VsZWN0b3IgPSB0aGlzLl9jb25maWcudGFyZ2V0ICsgJyAnICsgU2VsZWN0b3IuTkFWX0xJTktTICsgJywnICsgKHRoaXMuX2NvbmZpZy50YXJnZXQgKyAnICcgKyBTZWxlY3Rvci5EUk9QRE9XTl9JVEVNUyk7XG4gICAgICAgIHRoaXMuX29mZnNldHMgPSBbXTtcbiAgICAgICAgdGhpcy5fdGFyZ2V0cyA9IFtdO1xuICAgICAgICB0aGlzLl9hY3RpdmVUYXJnZXQgPSBudWxsO1xuICAgICAgICB0aGlzLl9zY3JvbGxIZWlnaHQgPSAwO1xuXG4gICAgICAgICQodGhpcy5fc2Nyb2xsRWxlbWVudCkub24oRXZlbnQuU0NST0xMLCAkLnByb3h5KHRoaXMuX3Byb2Nlc3MsIHRoaXMpKTtcblxuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICAgICAgdGhpcy5fcHJvY2VzcygpO1xuICAgICAgfVxuXG4gICAgICAvKipcbiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICogRGF0YSBBcGkgaW1wbGVtZW50YXRpb25cbiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICovXG5cbiAgICAgIC8vIGdldHRlcnNcblxuICAgICAgX2NyZWF0ZUNsYXNzKFNjcm9sbFNweSwgW3tcbiAgICAgICAga2V5OiAncmVmcmVzaCcsXG5cbiAgICAgICAgLy8gcHVibGljXG5cbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlZnJlc2goKSB7XG4gICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcblxuICAgICAgICAgIHZhciBhdXRvTWV0aG9kID0gdGhpcy5fc2Nyb2xsRWxlbWVudCAhPT0gdGhpcy5fc2Nyb2xsRWxlbWVudC53aW5kb3cgPyBPZmZzZXRNZXRob2QuUE9TSVRJT04gOiBPZmZzZXRNZXRob2QuT0ZGU0VUO1xuXG4gICAgICAgICAgdmFyIG9mZnNldE1ldGhvZCA9IHRoaXMuX2NvbmZpZy5tZXRob2QgPT09ICdhdXRvJyA/IGF1dG9NZXRob2QgOiB0aGlzLl9jb25maWcubWV0aG9kO1xuXG4gICAgICAgICAgdmFyIG9mZnNldEJhc2UgPSBvZmZzZXRNZXRob2QgPT09IE9mZnNldE1ldGhvZC5QT1NJVElPTiA/IHRoaXMuX2dldFNjcm9sbFRvcCgpIDogMDtcblxuICAgICAgICAgIHRoaXMuX29mZnNldHMgPSBbXTtcbiAgICAgICAgICB0aGlzLl90YXJnZXRzID0gW107XG5cbiAgICAgICAgICB0aGlzLl9zY3JvbGxIZWlnaHQgPSB0aGlzLl9nZXRTY3JvbGxIZWlnaHQoKTtcblxuICAgICAgICAgIHZhciB0YXJnZXRzID0gJC5tYWtlQXJyYXkoJCh0aGlzLl9zZWxlY3RvcikpO1xuXG4gICAgICAgICAgdGFyZ2V0cy5tYXAoZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0U2VsZWN0b3IgPSBfVXRpbFsnZGVmYXVsdCddLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQoZWxlbWVudCk7XG5cbiAgICAgICAgICAgIGlmICh0YXJnZXRTZWxlY3Rvcikge1xuICAgICAgICAgICAgICB0YXJnZXQgPSAkKHRhcmdldFNlbGVjdG9yKVswXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRhcmdldCAmJiAodGFyZ2V0Lm9mZnNldFdpZHRoIHx8IHRhcmdldC5vZmZzZXRIZWlnaHQpKSB7XG4gICAgICAgICAgICAgIC8vIHRvZG8gKGZhdCk6IHJlbW92ZSBza2V0Y2ggcmVsaWFuY2Ugb24galF1ZXJ5IHBvc2l0aW9uL29mZnNldFxuICAgICAgICAgICAgICByZXR1cm4gWyQodGFyZ2V0KVtvZmZzZXRNZXRob2RdKCkudG9wICsgb2Zmc2V0QmFzZSwgdGFyZ2V0U2VsZWN0b3JdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICAgICAgfSkuc29ydChmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgcmV0dXJuIGFbMF0gLSBiWzBdO1xuICAgICAgICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgIF90aGlzLl9vZmZzZXRzLnB1c2goaXRlbVswXSk7XG4gICAgICAgICAgICBfdGhpcy5fdGFyZ2V0cy5wdXNoKGl0ZW1bMV0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIGtleTogJ2Rpc3Bvc2UnLFxuICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZGlzcG9zZSgpIHtcbiAgICAgICAgICAkLnJlbW92ZURhdGEodGhpcy5fZWxlbWVudCwgREFUQV9LRVkpO1xuICAgICAgICAgICQodGhpcy5fc2Nyb2xsRWxlbWVudCkub2ZmKEVWRU5UX0tFWSk7XG5cbiAgICAgICAgICB0aGlzLl9lbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9zY3JvbGxFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9jb25maWcgPSBudWxsO1xuICAgICAgICAgIHRoaXMuX3NlbGVjdG9yID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9vZmZzZXRzID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl90YXJnZXRzID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9hY3RpdmVUYXJnZXQgPSBudWxsO1xuICAgICAgICAgIHRoaXMuX3Njcm9sbEhlaWdodCA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBwcml2YXRlXG5cbiAgICAgIH0sIHtcbiAgICAgICAga2V5OiAnX2dldENvbmZpZycsXG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0Q29uZmlnKGNvbmZpZykge1xuICAgICAgICAgIGNvbmZpZyA9ICQuZXh0ZW5kKHt9LCBEZWZhdWx0LCBjb25maWcpO1xuXG4gICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcudGFyZ2V0ICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdmFyIGlkID0gJChjb25maWcudGFyZ2V0KS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgaWYgKCFpZCkge1xuICAgICAgICAgICAgICBpZCA9IF9VdGlsWydkZWZhdWx0J10uZ2V0VUlEKE5BTUUpO1xuICAgICAgICAgICAgICAkKGNvbmZpZy50YXJnZXQpLmF0dHIoJ2lkJywgaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uZmlnLnRhcmdldCA9ICcjJyArIGlkO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIF9VdGlsWydkZWZhdWx0J10udHlwZUNoZWNrQ29uZmlnKE5BTUUsIGNvbmZpZywgRGVmYXVsdFR5cGUpO1xuXG4gICAgICAgICAgcmV0dXJuIGNvbmZpZztcbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICBrZXk6ICdfZ2V0U2Nyb2xsVG9wJyxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRTY3JvbGxUb3AoKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbEVsZW1lbnQgPT09IHdpbmRvdyA/IHRoaXMuX3Njcm9sbEVsZW1lbnQuc2Nyb2xsWSA6IHRoaXMuX3Njcm9sbEVsZW1lbnQuc2Nyb2xsVG9wO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIGtleTogJ19nZXRTY3JvbGxIZWlnaHQnLFxuICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFNjcm9sbEhlaWdodCgpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsRWxlbWVudC5zY3JvbGxIZWlnaHQgfHwgTWF0aC5tYXgoZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIGtleTogJ19wcm9jZXNzJyxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9wcm9jZXNzKCkge1xuICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLl9nZXRTY3JvbGxUb3AoKSArIHRoaXMuX2NvbmZpZy5vZmZzZXQ7XG4gICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IHRoaXMuX2dldFNjcm9sbEhlaWdodCgpO1xuICAgICAgICAgIHZhciBtYXhTY3JvbGwgPSB0aGlzLl9jb25maWcub2Zmc2V0ICsgc2Nyb2xsSGVpZ2h0IC0gdGhpcy5fc2Nyb2xsRWxlbWVudC5vZmZzZXRIZWlnaHQ7XG5cbiAgICAgICAgICBpZiAodGhpcy5fc2Nyb2xsSGVpZ2h0ICE9PSBzY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChzY3JvbGxUb3AgPj0gbWF4U2Nyb2xsKSB7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5fdGFyZ2V0c1t0aGlzLl90YXJnZXRzLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5fYWN0aXZlVGFyZ2V0ICE9PSB0YXJnZXQpIHtcbiAgICAgICAgICAgICAgdGhpcy5fYWN0aXZhdGUodGFyZ2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAodGhpcy5fYWN0aXZlVGFyZ2V0ICYmIHNjcm9sbFRvcCA8IHRoaXMuX29mZnNldHNbMF0pIHtcbiAgICAgICAgICAgIHRoaXMuX2FjdGl2ZVRhcmdldCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLl9jbGVhcigpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9vZmZzZXRzLmxlbmd0aDsgaS0tOykge1xuICAgICAgICAgICAgdmFyIGlzQWN0aXZlVGFyZ2V0ID0gdGhpcy5fYWN0aXZlVGFyZ2V0ICE9PSB0aGlzLl90YXJnZXRzW2ldICYmIHNjcm9sbFRvcCA+PSB0aGlzLl9vZmZzZXRzW2ldICYmICh0aGlzLl9vZmZzZXRzW2kgKyAxXSA9PT0gdW5kZWZpbmVkIHx8IHNjcm9sbFRvcCA8IHRoaXMuX29mZnNldHNbaSArIDFdKTtcblxuICAgICAgICAgICAgaWYgKGlzQWN0aXZlVGFyZ2V0KSB7XG4gICAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlKHRoaXMuX3RhcmdldHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICBrZXk6ICdfYWN0aXZhdGUnLFxuICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2FjdGl2YXRlKHRhcmdldCkge1xuICAgICAgICAgIHRoaXMuX2FjdGl2ZVRhcmdldCA9IHRhcmdldDtcblxuICAgICAgICAgIHRoaXMuX2NsZWFyKCk7XG5cbiAgICAgICAgICB2YXIgcXVlcmllcyA9IHRoaXMuX3NlbGVjdG9yLnNwbGl0KCcsJyk7XG4gICAgICAgICAgcXVlcmllcyA9IHF1ZXJpZXMubWFwKGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgcmV0dXJuIHNlbGVjdG9yICsgJ1tkYXRhLXRhcmdldD1cIicgKyB0YXJnZXQgKyAnXCJdLCcgKyAoc2VsZWN0b3IgKyAnW2hyZWY9XCInICsgdGFyZ2V0ICsgJ1wiXScpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgdmFyICRsaW5rID0gJChxdWVyaWVzLmpvaW4oJywnKSk7XG5cbiAgICAgICAgICBpZiAoJGxpbmsuaGFzQ2xhc3MoQ2xhc3NOYW1lLkRST1BET1dOX0lURU0pKSB7XG4gICAgICAgICAgICAkbGluay5jbG9zZXN0KFNlbGVjdG9yLkRST1BET1dOKS5maW5kKFNlbGVjdG9yLkRST1BET1dOX1RPR0dMRSkuYWRkQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSk7XG4gICAgICAgICAgICAkbGluay5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gdG9kbyAoZmF0KSB0aGlzIGlzIGtpbmRhIHN1c+KAplxuICAgICAgICAgICAgLy8gcmVjdXJzaXZlbHkgYWRkIGFjdGl2ZXMgdG8gdGVzdGVkIG5hdi1saW5rc1xuICAgICAgICAgICAgJGxpbmsucGFyZW50cyhTZWxlY3Rvci5MSSkuZmluZChTZWxlY3Rvci5OQVZfTElOS1MpLmFkZENsYXNzKENsYXNzTmFtZS5BQ1RJVkUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgICQodGhpcy5fc2Nyb2xsRWxlbWVudCkudHJpZ2dlcihFdmVudC5BQ1RJVkFURSwge1xuICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogdGFyZ2V0XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sIHtcbiAgICAgICAga2V5OiAnX2NsZWFyJyxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jbGVhcigpIHtcbiAgICAgICAgICAkKHRoaXMuX3NlbGVjdG9yKS5maWx0ZXIoU2VsZWN0b3IuQUNUSVZFKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHN0YXRpY1xuXG4gICAgICB9XSwgW3tcbiAgICAgICAga2V5OiAnX2pRdWVyeUludGVyZmFjZScsXG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfalF1ZXJ5SW50ZXJmYWNlKGNvbmZpZykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGRhdGEgPSAkKHRoaXMpLmRhdGEoREFUQV9LRVkpO1xuICAgICAgICAgICAgdmFyIF9jb25maWcgPSB0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0JyAmJiBjb25maWcgfHwgbnVsbDtcblxuICAgICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICAgIGRhdGEgPSBuZXcgU2Nyb2xsU3B5KHRoaXMsIF9jb25maWcpO1xuICAgICAgICAgICAgICAkKHRoaXMpLmRhdGEoREFUQV9LRVksIGRhdGEpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgaWYgKGRhdGFbY29uZmlnXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBtZXRob2QgbmFtZWQgXCInICsgY29uZmlnICsgJ1wiJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZGF0YVtjb25maWddKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sIHtcbiAgICAgICAga2V5OiAnVkVSU0lPTicsXG4gICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkge1xuICAgICAgICAgIHJldHVybiBWRVJTSU9OO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIGtleTogJ0RlZmF1bHQnLFxuICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHtcbiAgICAgICAgICByZXR1cm4gRGVmYXVsdDtcbiAgICAgICAgfVxuICAgICAgfV0pO1xuXG4gICAgICByZXR1cm4gU2Nyb2xsU3B5O1xuICAgIH0pKCk7XG5cbiAgICAkKHdpbmRvdykub24oRXZlbnQuTE9BRF9EQVRBX0FQSSwgZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIHNjcm9sbFNweXMgPSAkLm1ha2VBcnJheSgkKFNlbGVjdG9yLkRBVEFfU1BZKSk7XG5cbiAgICAgIGZvciAodmFyIGkgPSBzY3JvbGxTcHlzLmxlbmd0aDsgaS0tOykge1xuICAgICAgICB2YXIgJHNweSA9ICQoc2Nyb2xsU3B5c1tpXSk7XG4gICAgICAgIFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlLmNhbGwoJHNweSwgJHNweS5kYXRhKCkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICogalF1ZXJ5XG4gICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICovXG5cbiAgICAkLmZuW05BTUVdID0gU2Nyb2xsU3B5Ll9qUXVlcnlJbnRlcmZhY2U7XG4gICAgJC5mbltOQU1FXS5Db25zdHJ1Y3RvciA9IFNjcm9sbFNweTtcbiAgICAkLmZuW05BTUVdLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAkLmZuW05BTUVdID0gSlFVRVJZX05PX0NPTkZMSUNUO1xuICAgICAgcmV0dXJuIFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlO1xuICAgIH07XG5cbiAgICByZXR1cm4gU2Nyb2xsU3B5O1xuICB9KShqUXVlcnkpO1xuXG4gIG1vZHVsZS5leHBvcnRzID0gU2Nyb2xsU3B5O1xufSk7XG4iXX0=