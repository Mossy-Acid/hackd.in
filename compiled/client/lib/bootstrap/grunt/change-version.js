#!/usr/bin/env node

'use strict';

/*!
 * Script to update version number references in the project.
 * Copyright 2015 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */

var fs = require('fs');
var path = require('path');
var sh = require('shelljs');
sh.config.fatal = true;
var sed = sh.sed;

// Blame TC39... https://github.com/benjamingr/RegExp.escape/issues/37
RegExp.quote = function (string) {
  return string.replace(/[-\\^$*+?.()|[\]{}]/g, '\\$&');
};
RegExp.quoteReplacement = function (string) {
  return string.replace(/[$]/g, '$$');
};

var DRY_RUN = false;

function walkAsync(directory, excludedDirectories, fileCallback, errback) {
  if (excludedDirectories.has(path.parse(directory).base)) {
    return;
  }
  fs.readdir(directory, function (err, names) {
    if (err) {
      errback(err);
      return;
    }
    names.forEach(function (name) {
      var filepath = path.join(directory, name);
      fs.lstat(filepath, function (err, stats) {
        if (err) {
          process.nextTick(errback, err);
          return;
        }
        if (stats.isSymbolicLink()) {
          return;
        } else if (stats.isDirectory()) {
          process.nextTick(walkAsync, filepath, excludedDirectories, fileCallback, errback);
        } else if (stats.isFile()) {
          process.nextTick(fileCallback, filepath);
        }
      });
    });
  });
}

function replaceRecursively(directory, excludedDirectories, allowedExtensions, original, replacement) {
  original = new RegExp(RegExp.quote(original), 'g');
  replacement = RegExp.quoteReplacement(replacement);
  var updateFile = !DRY_RUN ? function (filepath) {
    if (allowedExtensions.has(path.parse(filepath).ext)) {
      sed('-i', original, replacement, filepath);
    }
  } : function (filepath) {
    if (allowedExtensions.has(path.parse(filepath).ext)) {
      console.log('FILE: ' + filepath);
    } else {
      console.log('EXCLUDED:' + filepath);
    }
  };
  walkAsync('.', excludedDirectories, updateFile, function (err) {
    console.error('ERROR while traversing directory!:');
    console.error(err);
    process.exit(1);
  });
}

function main(args) {
  if (args.length !== 2) {
    console.error('USAGE: change-version old_version new_version');
    console.error('Got arguments:', args);
    process.exit(1);
  }
  var oldVersion = args[0];
  var newVersion = args[1];
  var EXCLUDED_DIRS = new Set(['.git', 'node_modules', 'vendor']);
  var INCLUDED_EXTENSIONS = new Set([
  // This extension whitelist is how we avoid modifying binary files
  '', '.css', '.html', '.js', '.json', '.md', '.scss', '.txt', '.yml']);
  replaceRecursively('.', EXCLUDED_DIRS, INCLUDED_EXTENSIONS, oldVersion, newVersion);
};

main(process.argv.slice(2));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2NsaWVudC9saWIvYm9vdHN0cmFwL2dydW50L2NoYW5nZS12ZXJzaW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQTs7Ozs7Ozs7QUFPQSxJQUFJLEtBQUssUUFBUSxJQUFSLENBQVQ7QUFDQSxJQUFJLE9BQU8sUUFBUSxNQUFSLENBQVg7QUFDQSxJQUFJLEtBQUssUUFBUSxTQUFSLENBQVQ7QUFDQSxHQUFHLE1BQUgsQ0FBVSxLQUFWLEdBQWtCLElBQWxCO0FBQ0EsSUFBSSxNQUFNLEdBQUcsR0FBYjs7O0FBR0EsT0FBTyxLQUFQLEdBQWUsVUFBVSxNQUFWLEVBQWtCO0FBQy9CLFNBQU8sT0FBTyxPQUFQLENBQWUsc0JBQWYsRUFBdUMsTUFBdkMsQ0FBUDtBQUNELENBRkQ7QUFHQSxPQUFPLGdCQUFQLEdBQTBCLFVBQVUsTUFBVixFQUFrQjtBQUMxQyxTQUFPLE9BQU8sT0FBUCxDQUFlLE1BQWYsRUFBdUIsSUFBdkIsQ0FBUDtBQUNELENBRkQ7O0FBSUEsSUFBSSxVQUFVLEtBQWQ7O0FBRUEsU0FBUyxTQUFULENBQW1CLFNBQW5CLEVBQThCLG1CQUE5QixFQUFtRCxZQUFuRCxFQUFpRSxPQUFqRSxFQUEwRTtBQUN4RSxNQUFJLG9CQUFvQixHQUFwQixDQUF3QixLQUFLLEtBQUwsQ0FBVyxTQUFYLEVBQXNCLElBQTlDLENBQUosRUFBeUQ7QUFDdkQ7QUFDRDtBQUNELEtBQUcsT0FBSCxDQUFXLFNBQVgsRUFBc0IsVUFBVSxHQUFWLEVBQWUsS0FBZixFQUFzQjtBQUMxQyxRQUFJLEdBQUosRUFBUztBQUNQLGNBQVEsR0FBUjtBQUNBO0FBQ0Q7QUFDRCxVQUFNLE9BQU4sQ0FBYyxVQUFVLElBQVYsRUFBZ0I7QUFDNUIsVUFBSSxXQUFXLEtBQUssSUFBTCxDQUFVLFNBQVYsRUFBcUIsSUFBckIsQ0FBZjtBQUNBLFNBQUcsS0FBSCxDQUFTLFFBQVQsRUFBbUIsVUFBVSxHQUFWLEVBQWUsS0FBZixFQUFzQjtBQUN2QyxZQUFJLEdBQUosRUFBUztBQUNQLGtCQUFRLFFBQVIsQ0FBaUIsT0FBakIsRUFBMEIsR0FBMUI7QUFDQTtBQUNEO0FBQ0QsWUFBSSxNQUFNLGNBQU4sRUFBSixFQUE0QjtBQUMxQjtBQUNELFNBRkQsTUFHSyxJQUFJLE1BQU0sV0FBTixFQUFKLEVBQXlCO0FBQzVCLGtCQUFRLFFBQVIsQ0FBaUIsU0FBakIsRUFBNEIsUUFBNUIsRUFBc0MsbUJBQXRDLEVBQTJELFlBQTNELEVBQXlFLE9BQXpFO0FBQ0QsU0FGSSxNQUdBLElBQUksTUFBTSxNQUFOLEVBQUosRUFBb0I7QUFDdkIsa0JBQVEsUUFBUixDQUFpQixZQUFqQixFQUErQixRQUEvQjtBQUNEO0FBQ0YsT0FkRDtBQWVELEtBakJEO0FBa0JELEdBdkJEO0FBd0JEOztBQUVELFNBQVMsa0JBQVQsQ0FBNEIsU0FBNUIsRUFBdUMsbUJBQXZDLEVBQTRELGlCQUE1RCxFQUErRSxRQUEvRSxFQUF5RixXQUF6RixFQUFzRztBQUNwRyxhQUFXLElBQUksTUFBSixDQUFXLE9BQU8sS0FBUCxDQUFhLFFBQWIsQ0FBWCxFQUFtQyxHQUFuQyxDQUFYO0FBQ0EsZ0JBQWMsT0FBTyxnQkFBUCxDQUF3QixXQUF4QixDQUFkO0FBQ0EsTUFBSSxhQUFhLENBQUMsT0FBRCxHQUFZLFVBQVUsUUFBVixFQUFvQjtBQUM3QyxRQUFJLGtCQUFrQixHQUFsQixDQUFzQixLQUFLLEtBQUwsQ0FBVyxRQUFYLEVBQXFCLEdBQTNDLENBQUosRUFBcUQ7QUFDbkQsVUFBSSxJQUFKLEVBQVUsUUFBVixFQUFvQixXQUFwQixFQUFpQyxRQUFqQztBQUNEO0FBQ0YsR0FKYyxHQUlULFVBQVUsUUFBVixFQUFvQjtBQUN4QixRQUFJLGtCQUFrQixHQUFsQixDQUFzQixLQUFLLEtBQUwsQ0FBVyxRQUFYLEVBQXFCLEdBQTNDLENBQUosRUFBcUQ7QUFDbkQsY0FBUSxHQUFSLENBQVksV0FBVyxRQUF2QjtBQUNELEtBRkQsTUFHSztBQUNILGNBQVEsR0FBUixDQUFZLGNBQWMsUUFBMUI7QUFDRDtBQUNGLEdBWEg7QUFZQSxZQUFVLEdBQVYsRUFBZSxtQkFBZixFQUFvQyxVQUFwQyxFQUFnRCxVQUFVLEdBQVYsRUFBZTtBQUM3RCxZQUFRLEtBQVIsQ0FBYyxvQ0FBZDtBQUNBLFlBQVEsS0FBUixDQUFjLEdBQWQ7QUFDQSxZQUFRLElBQVIsQ0FBYSxDQUFiO0FBQ0QsR0FKRDtBQUtEOztBQUVELFNBQVMsSUFBVCxDQUFjLElBQWQsRUFBb0I7QUFDbEIsTUFBSSxLQUFLLE1BQUwsS0FBZ0IsQ0FBcEIsRUFBdUI7QUFDckIsWUFBUSxLQUFSLENBQWMsK0NBQWQ7QUFDQSxZQUFRLEtBQVIsQ0FBYyxnQkFBZCxFQUFnQyxJQUFoQztBQUNBLFlBQVEsSUFBUixDQUFhLENBQWI7QUFDRDtBQUNELE1BQUksYUFBYSxLQUFLLENBQUwsQ0FBakI7QUFDQSxNQUFJLGFBQWEsS0FBSyxDQUFMLENBQWpCO0FBQ0EsTUFBSSxnQkFBZ0IsSUFBSSxHQUFKLENBQVEsQ0FDMUIsTUFEMEIsRUFFMUIsY0FGMEIsRUFHMUIsUUFIMEIsQ0FBUixDQUFwQjtBQUtBLE1BQUksc0JBQXNCLElBQUksR0FBSixDQUFROztBQUVoQyxJQUZnQyxFQUdoQyxNQUhnQyxFQUloQyxPQUpnQyxFQUtoQyxLQUxnQyxFQU1oQyxPQU5nQyxFQU9oQyxLQVBnQyxFQVFoQyxPQVJnQyxFQVNoQyxNQVRnQyxFQVVoQyxNQVZnQyxDQUFSLENBQTFCO0FBWUEscUJBQW1CLEdBQW5CLEVBQXdCLGFBQXhCLEVBQXVDLG1CQUF2QyxFQUE0RCxVQUE1RCxFQUF3RSxVQUF4RTtBQUNEOztBQUVELEtBQUssUUFBUSxJQUFSLENBQWEsS0FBYixDQUFtQixDQUFuQixDQUFMIiwiZmlsZSI6ImNoYW5nZS12ZXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4ndXNlIHN0cmljdCc7XG5cbi8qIVxuICogU2NyaXB0IHRvIHVwZGF0ZSB2ZXJzaW9uIG51bWJlciByZWZlcmVuY2VzIGluIHRoZSBwcm9qZWN0LlxuICogQ29weXJpZ2h0IDIwMTUgVHdpdHRlciwgSW5jLlxuICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSlcbiAqL1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIHNoID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuc2guY29uZmlnLmZhdGFsID0gdHJ1ZTtcbnZhciBzZWQgPSBzaC5zZWQ7XG5cbi8vIEJsYW1lIFRDMzkuLi4gaHR0cHM6Ly9naXRodWIuY29tL2JlbmphbWluZ3IvUmVnRXhwLmVzY2FwZS9pc3N1ZXMvMzdcblJlZ0V4cC5xdW90ZSA9IGZ1bmN0aW9uIChzdHJpbmcpIHtcbiAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVxcXFxeJCorPy4oKXxbXFxde31dL2csICdcXFxcJCYnKTtcbn07XG5SZWdFeHAucXVvdGVSZXBsYWNlbWVudCA9IGZ1bmN0aW9uIChzdHJpbmcpIHtcbiAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bJF0vZywgJyQkJyk7XG59O1xuXG52YXIgRFJZX1JVTiA9IGZhbHNlO1xuXG5mdW5jdGlvbiB3YWxrQXN5bmMoZGlyZWN0b3J5LCBleGNsdWRlZERpcmVjdG9yaWVzLCBmaWxlQ2FsbGJhY2ssIGVycmJhY2spIHtcbiAgaWYgKGV4Y2x1ZGVkRGlyZWN0b3JpZXMuaGFzKHBhdGgucGFyc2UoZGlyZWN0b3J5KS5iYXNlKSkge1xuICAgIHJldHVybjtcbiAgfVxuICBmcy5yZWFkZGlyKGRpcmVjdG9yeSwgZnVuY3Rpb24gKGVyciwgbmFtZXMpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBlcnJiYWNrKGVycik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIG5hbWVzLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgIHZhciBmaWxlcGF0aCA9IHBhdGguam9pbihkaXJlY3RvcnksIG5hbWUpO1xuICAgICAgZnMubHN0YXQoZmlsZXBhdGgsIGZ1bmN0aW9uIChlcnIsIHN0YXRzKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGVycmJhY2ssIGVycik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0cy5pc1N5bWJvbGljTGluaygpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKHdhbGtBc3luYywgZmlsZXBhdGgsIGV4Y2x1ZGVkRGlyZWN0b3JpZXMsIGZpbGVDYWxsYmFjaywgZXJyYmFjayk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZpbGVDYWxsYmFjaywgZmlsZXBhdGgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VSZWN1cnNpdmVseShkaXJlY3RvcnksIGV4Y2x1ZGVkRGlyZWN0b3JpZXMsIGFsbG93ZWRFeHRlbnNpb25zLCBvcmlnaW5hbCwgcmVwbGFjZW1lbnQpIHtcbiAgb3JpZ2luYWwgPSBuZXcgUmVnRXhwKFJlZ0V4cC5xdW90ZShvcmlnaW5hbCksICdnJyk7XG4gIHJlcGxhY2VtZW50ID0gUmVnRXhwLnF1b3RlUmVwbGFjZW1lbnQocmVwbGFjZW1lbnQpO1xuICB2YXIgdXBkYXRlRmlsZSA9ICFEUllfUlVOID8gKGZ1bmN0aW9uIChmaWxlcGF0aCkge1xuICAgICAgaWYgKGFsbG93ZWRFeHRlbnNpb25zLmhhcyhwYXRoLnBhcnNlKGZpbGVwYXRoKS5leHQpKSB7XG4gICAgICAgIHNlZCgnLWknLCBvcmlnaW5hbCwgcmVwbGFjZW1lbnQsIGZpbGVwYXRoKTtcbiAgICAgIH1cbiAgICB9KSA6IChmdW5jdGlvbiAoZmlsZXBhdGgpIHtcbiAgICAgIGlmIChhbGxvd2VkRXh0ZW5zaW9ucy5oYXMocGF0aC5wYXJzZShmaWxlcGF0aCkuZXh0KSkge1xuICAgICAgICBjb25zb2xlLmxvZygnRklMRTogJyArIGZpbGVwYXRoKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnRVhDTFVERUQ6JyArIGZpbGVwYXRoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgd2Fsa0FzeW5jKCcuJywgZXhjbHVkZWREaXJlY3RvcmllcywgdXBkYXRlRmlsZSwgZnVuY3Rpb24gKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0VSUk9SIHdoaWxlIHRyYXZlcnNpbmcgZGlyZWN0b3J5ITonKVxuICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBtYWluKGFyZ3MpIHtcbiAgaWYgKGFyZ3MubGVuZ3RoICE9PSAyKSB7XG4gICAgY29uc29sZS5lcnJvcignVVNBR0U6IGNoYW5nZS12ZXJzaW9uIG9sZF92ZXJzaW9uIG5ld192ZXJzaW9uJyk7XG4gICAgY29uc29sZS5lcnJvcignR290IGFyZ3VtZW50czonLCBhcmdzKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH1cbiAgdmFyIG9sZFZlcnNpb24gPSBhcmdzWzBdO1xuICB2YXIgbmV3VmVyc2lvbiA9IGFyZ3NbMV07XG4gIHZhciBFWENMVURFRF9ESVJTID0gbmV3IFNldChbXG4gICAgJy5naXQnLFxuICAgICdub2RlX21vZHVsZXMnLFxuICAgICd2ZW5kb3InXG4gIF0pO1xuICB2YXIgSU5DTFVERURfRVhURU5TSU9OUyA9IG5ldyBTZXQoW1xuICAgIC8vIFRoaXMgZXh0ZW5zaW9uIHdoaXRlbGlzdCBpcyBob3cgd2UgYXZvaWQgbW9kaWZ5aW5nIGJpbmFyeSBmaWxlc1xuICAgICcnLFxuICAgICcuY3NzJyxcbiAgICAnLmh0bWwnLFxuICAgICcuanMnLFxuICAgICcuanNvbicsXG4gICAgJy5tZCcsXG4gICAgJy5zY3NzJyxcbiAgICAnLnR4dCcsXG4gICAgJy55bWwnXG4gIF0pO1xuICByZXBsYWNlUmVjdXJzaXZlbHkoJy4nLCBFWENMVURFRF9ESVJTLCBJTkNMVURFRF9FWFRFTlNJT05TLCBvbGRWZXJzaW9uLCBuZXdWZXJzaW9uKTtcbn07XG5cbm1haW4ocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKTtcbiJdfQ==